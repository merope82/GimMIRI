/*****************************************************************************/
/**                             GimMIRI                                     **/
/**                                                                         **/
/** Code to model the internal scattering of light in detectors, using      **/
/** probabilities derived from quantum electrodynamics.                     **/
/** GPU version								    **/
/*****************************************************************************/
/** Release version & date:                                                 **/
/**/ const char *Version = "1.10";                                         /**/
/**/ const char *VDate   = "01.06.2019";                                   /**/
/** Author: Andras Gaspar (agaspar@as.arizona.edu)                          **/
/** Revision: 0.01 - Initial						    **/
/** Revision: 1.00 - Released version					    **/
/**           Includes Fresnel Eqs for total internal reflection at top     **/
/*****************************************************************************/
#include <stdio.h>
#include <math.h>
#include <stdlib.h>
#include <string.h>
#include <memory.h>
#include <curand.h>
#include <curand_kernel.h>
#include "fitsio.h"
#include "imMIRI.h"
#include "GimMIRI.cuh"
#include "externC.h"

// Global config parameters
configdata cconfig;
// constant values stored in GPUs
__constant__ int   method;
__constant__ int   nx1;
__constant__ int   nx2;
__constant__ int   nx1multnx2;
__constant__ int   subp;
__constant__ int   sizex;
__constant__ int   sizey;
__constant__ int   szxmultszy;
__constant__ float oamp;
__constant__ float rad;
__constant__ float alpha;
__constant__ float Kap;
__constant__ float Trans;
__constant__ float lam;
__constant__ float pxsc;
__constant__ float Dap;
__constant__ float nx1over2;
__constant__ float nx2over2;
__constant__ float pxoverosamp;
__constant__ float pxoversubp;
__constant__ float szxover2;
__constant__ float szyover2;
__constant__ float xoff;
__constant__ float yoff;
__device__ unsigned long long zm4;
__device__ unsigned long long zm3;
__device__ unsigned long long zm2;
__device__ unsigned long long zm1;
__device__ unsigned long long path1;
__device__ unsigned long long path2;
__device__ unsigned long long path3;
__device__ unsigned long long path4;
__device__ unsigned long long path5;
__device__ unsigned long long path6;
__device__ unsigned long long path7;
__device__ unsigned long long path8;
__device__ unsigned long long path9;
__device__ unsigned long long path10;
__device__ unsigned long long path11;
__device__ unsigned long long path12;
__device__ unsigned long long path13;
__device__ unsigned long long path14;
__device__ unsigned long long path15;
__device__ unsigned long long path16;
__device__ unsigned long long path17;
__device__ unsigned long long path18;
__device__ unsigned long long path19;
__device__ unsigned long long path20;
__device__ unsigned long long path21;
__device__ unsigned long long path22;
__device__ unsigned long long path23;
__device__ unsigned long long path24;
__device__ unsigned long long path25;
__device__ unsigned long long path26;
__device__ unsigned long long path27;
__device__ unsigned long long path28;
__device__ unsigned long long path29;
__device__ unsigned long long path30;
__device__ unsigned long long path31;
__device__ unsigned long long path32;
__device__ unsigned long long path33;
__device__ unsigned long long path34;
__device__ unsigned long long path35;
__device__ unsigned long long path36;
__device__ unsigned long long path37;
__device__ unsigned long long path38;
__device__ unsigned long long path39;
__device__ unsigned long long path40;
__device__ unsigned long long path41;
__device__ unsigned long long path42;
__device__ unsigned long long path43;
__device__ unsigned long long path44;
__device__ unsigned long long path45;
__device__ unsigned long long path46;
__device__ unsigned long long path47;
__device__ unsigned long long path48;
__device__ unsigned long long path49;
__device__ unsigned long long path50;

int main(int argc,char *argv[]){
    configdata   *cfg   = &cconfig;
    char	 *param = NULL;
    flux	 img_h,*img_d;
    input	 psf_h,*psf_d;
    globalstruct *global;
    
    // Define parameter file with input arguments
    if ( argc==1 )                            exit_with_usage(0);
    for ( int i=1 ; i<argc ; i++ ){
        if ( strcmp(argv[i],"-h")==0 )
            exit_with_usage(0);
        else if ( strcmp(argv[i],"-i")==0 ){
            i++;if ( i==argc )                exit_with_usage(1);
            param=argv[i];
        }
        else                                  exit_with_usage(0);
    }
    if ( param == NULL )		      exit_with_usage(2);

    read_in_param(param);
    print_header(Version,VDate);
    
    // Defining device pointers
    img_d  = (flux         *)malloc(sizeof(flux)        *cfg->ndev);
    psf_d  = (input        *)malloc(sizeof(input)       *cfg->ndev);
    global = (globalstruct *)malloc(sizeof(globalstruct)*cfg->ndev);

    // Reset GPUs
    reset_cuda();

    // If using a fits input, get image data
    if ( cfg->method == 0 ) getimdata();

    // Check if there is enough system and GPU memory for model
    checkmem();

    // Initialize image on host and device(s) and the fits psf (if used)
    init_img(&img_h,&img_d);
    init_psf(&psf_h);

    // If using a fits input, read in file and copy to device(s)
    if ( cfg->method == 0 ){
	fillinput(&psf_h);
	sortinput(&psf_h,&psf_d);
    }
    
    // Copy constant values needed to constant memory in device(s)
    fill_const();

    // Run model evolution
    evolve(psf_d,img_d,img_h,&global,Version);
    printdone();

    // Free system and device memory
    freeall(img_h,img_d,psf_h,psf_d,global);

 return 0;
}
                                                            